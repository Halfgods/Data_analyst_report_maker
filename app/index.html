<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #output { white-space: pre-wrap; background-color: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 20px; }
        .chart-container { margin-top: 15px; border: 1px solid #ccc; padding: 10px; }
        .chart-container img { max-width: 100%; height: auto; display: block; margin-top: 10px; }
        h2 { margin-top: 30px; }
    </style>
</head>
<body>
    <h1>Upload CSVs for Analysis</h1>

    <input type="file" id="csvFileInput" multiple accept=".csv">
    <button onclick="uploadFiles()">Upload and Process</button>

    <h2>Results:</h2>
    <div id="output"></div>

    <h2>Charts:</h2>
    <div id="chartsContainer"></div>

    <h2>Ask AI about Data:</h2>
    <input type="text" id="aiQuestionInput" placeholder="e.g., What is the average of X?">
    <button onclick="askAI()">Ask AI</button>
    <div id="aiAnswer"></div>

    <script>
        const API_BASE_URL = ""; // Adjust if your FastAPI runs on a different port/host
        let currentSessionId = null; // Store the session ID after upload

        async function uploadFiles() {
            const input = document.getElementById('csvFileInput');
            const files = input.files;

            if (files.length === 0) {
                alert('Please select at least one CSV file.');
                return;
            }

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            document.getElementById('output').textContent = 'Uploading files...';
            document.getElementById('chartsContainer').innerHTML = '';
            document.getElementById('aiAnswer').textContent = '';

            try {
                // Step 1: Upload CSVs
                const uploadResponse = await fetch(`${API_BASE_URL}/upload-csv/`, {
                    method: 'POST',
                    body: formData
                });
                const uploadData = await uploadResponse.json();

                if (!uploadResponse.ok) {
                    throw new Error(uploadData.detail || 'File upload failed.');
                }

                currentSessionId = uploadData.session_id; // Store session ID
                document.getElementById('output').textContent = `Files uploaded. Session ID: ${currentSessionId}
Processing data...`;

                // Step 2: Process data
                const processResponse = await fetch(`${API_BASE_URL}/process-data/${currentSessionId}`, {
                    method: 'POST'
                });
                const processData = await processResponse.json();

                if (!processResponse.ok) {
                    throw new Error(processData.detail || 'Data processing failed.');
                }

                document.getElementById('output').textContent = JSON.stringify(processData, null, 2);

                // Display Charts
                const chartsContainer = document.getElementById('chartsContainer');
                if (processData.analysis_results && processData.analysis_results.chart_urls) {
                    for (const chartType in processData.analysis_results.chart_urls) {
                        const chartUrls = processData.analysis_results.chart_urls[chartType];
                        chartUrls.forEach(url => {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'chart-container';
                            const imgTitle = document.createElement('h3');
                            imgTitle.textContent = chartType.replace('_', ' ').toUpperCase();
                            const img = document.createElement('img');
                            img.src = `${API_BASE_URL}${url}`;
                            img.alt = chartType;
                            imgContainer.appendChild(imgTitle);
                            imgContainer.appendChild(img);
                            chartsContainer.appendChild(imgContainer);
                        });
                    }
                }

            } catch (error) {
                document.getElementById('output').textContent = `Error: ${error.message}`;
                console.error('Error:', error);
            }
        }

        async function askAI() {
            if (!currentSessionId) {
                alert('Please upload and process CSVs first to get a session ID.');
                return;
            }

            const questionInput = document.getElementById('aiQuestionInput');
            const question = questionInput.value.trim();

            if (!question) {
                alert('Please enter a question.');
                return;
            }

            document.getElementById('aiAnswer').textContent = 'Asking AI...';

            try {
                const response = await fetch(`${API_BASE_URL}/query-data/${currentSessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question: question })
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to get AI answer.');
                }

                document.getElementById('aiAnswer').textContent = data.answer || data.error || 'No answer received.';

            } catch (error) {
                document.getElementById('aiAnswer').textContent = `Error: ${error.message}`;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>